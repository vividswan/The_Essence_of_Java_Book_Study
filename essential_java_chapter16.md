# Chapter 16 - 네트워킹

## 1. 네트워킹(Networking)

- 두 대 이상의 컴퓨터를 케이블로 연결하여 네트워크를 구성하는 것
  - 인터넷을 이용하는 다양한 네트워크 어플리케이션들이 늘어남
- 자바에서 제공하는 java.net 패키지를 사용해서 네트워크 어플리케이션의 데이터 통신 부분 작성 가능

### 1.1 클라이언트/서버(client/server)

- 컴퓨터 간의 관계를 역할로 구분하는 개념
  - 하드웨어의 사양으로 구분하는 것이 아님
- 서버는 서비스를 제공하는 컴퓨터
  - 일반적으로 다수의 클라이언트에게 서비스를 제공
  - 파일 서버, 메일 서버, 어플리케이션 서버 등이 존재
- 클라이언트는 서비스를 사용하는 컴퓨터
- 클라이언트로부터 요청받은 작업을 서버가 처리하여 결과를 제공하는 것이 서비스
- 서버는 서버 프로그램, 클라이언트는 서버 프로그램과 연결할 수 있는 클라이언트 프로그램이 필요
- 네트워크 구성 시 전용 서버를 두는 것을 서버 기반 모델
  - 서버 구축 비용과 관리 비용이 들지만 관리와 보안이 용이하고 안정적인 서비스
- 별도의 전용 서버 없이 각 클라이언트가 서버 역할을 동시에 수행하는 것이 P2P 모델(peer-to-peer)
  - 서버 구축 및 운용 비용을 절감할 수 있고 자원 활용을 극대화할 수 있지만 자원의 관리가 어렵고 보안이 취약

### 1.2 IP 주소(IP address)

- 컴퓨터(호스트)를 구별하는 데 사용되는 고유한 값
  - 인터넷에 연결된 모든 컴퓨터가 가짐
  - 4 byte(32bit)의 정수로 구성
- 네트워크 주소와 호스트 주소로 나누어짐
  - 각각 차지하는 bit 수는 구성에 따라 달라짐
  - 같은 네트워크에 포함되어 있다면 네트워크 주소가 동일
- IP 주소와 서브넷 마스크를 비트 연산자(&)로 연산하면 IP 주소에서 네트워크 주소만을 뽑아낼 수 있음
- 호스트 주소가 0인 것은 네트워크 자신, 255는 브로드캐스트 주소

### 1.3 InetAddress

- 자바에서 IP 주소를 다루기 위한 클래스
- IP 주소, 도메인명에 지정된 모든 호스트의 IP 주소, 호스트의 이름 등등을 확인할 수 있다.

### 1.4 URL(Uniform Resource Locator)

- 인터넷에 존재하는 여러 서버들이 제공하는 자원에 접근할 수 있는 주소를 표현
- '프로토콜://호스트명:포트번호/경로명/파일명?쿼리스트링#참조'의 형태
  - 프로토콜 : 서버와 통신하는 데 사용되는 통신 규약
  - 호스트명 : 자원을 제공하는 서버 이름
  - 포트 번호 : 통신에 사용되는 서버의 포트 번호
  - 경로명 : 접근하려는 자원이 저장된 서버상의 위치
  - 파일명 : 접근하려는 자원의 이름
  - 쿼리 : URL에서 '?' 이후의 부분
  - 참조 : URL에서 '#' 이후의 부분
- 자바에서는 URL을 다루기 위해 URL 클래스를 제공
  - `URL url = new URL("{{URL 주소}}")`와 같은 형식으로 인스턴스 생성

### 1.5 URLConnection

- 어플리케이션과 URL 간의 통신 연결을 나타내는 클래스의 최상위 클래스 (추상 클래스)
  - 자식 클래스로 HttpURLConnection, JarURLConnection
- openConnection()은 HttpURLConnection을 반환
  - openConnection()은 URL 클래스의 메서드
- 연결하고자 하는 자원에 접근하고 읽고 쓰기를 할 수 있음
  - 헤더의 필드값, 연결 종료 시간 지정, content 객체 반환, 허용 권한 반환 등등 ...
- URL 객체 생성 시 URL이 유효하지 않으면 Malformed - URLException이 발생
- URL의 openStream() 메서드는 openConnection을 호출해서 URLConnection을 얻은 다음 getInputStream()을 호출한 것과 같다.

## 2. 소켓 프로그래밍

- 소켓을 이용한 프로그래밍
  - 소켓은 프로세스 간의 통신에 사용되는 양쪽 끝단을 의미
  - 두 사람이 통신하기 위해 필요한 전화기와 비슷하다.
- 자바에서는 java.net 패키지를 통해 소켓 프로그래밍을 지원

### 2.1 TCP와 UDP

- TCP/IP 프로토콜은 이기종 시스템 간의 통신을 위한 표준 프로토콜
  - TCP와 UDP 모두 TCP/IP 프로토콜에 포함 (OSI 7계층의 전송계층에 해당)
- TCP
  - 연결 기반 (연결 후 통신, 1:1 통신)
  - 데이터의 경계를 구분 안 함
  - 신뢰 있는 데이터 전송 (순서, 수신 여부 보장, 패킷 관리해 줄 필요 X)
  - UDP 보다 느림
  - Socket, ServerSocket 클래스와 관련
- UDP
  - 비연결기반 (연결 없이 통신, 1:1, 1:n, n:n 통신방식)
  - 데이터의 경계를 구분
  - 신뢰성 없는 데이터 전송 (순서 바뀔 수 있음, 수신 여부 확인 X, 패킷 관리해 주어야 함)
  - TCP 보다 전송속도 빠름
  - DatagramSocket, DatagramPacket, MulticastSocket 클래스와 관련

### 2.2 TCP 소켓 프로그래밍

- 통신과정
  1. 서버 프로그램은 특정 포트에서 클라이언트의 연결 요청을 처리할 서버 소켓을 준비
  2. 클라이언트 프로그램은 접속할 서버의 IP 주소, 포트 정보를 가지고 소켓을 생성 후 서버에 연결
  3. 서버 소켓은 클라이언트 요청이 올 시 서버에 새로운 소켓을 생성 후 클라이언트의 소켓과 연결
  4. 클라이언트 소켓과 생성된 서버의 소켓은 서버 소켓과 관계없이 일대일 통신
- 서버 소켓에서는 실질적인 통신 X
  - 새로운 소켓을 생성하여 연결해 주는 역할
- 서버 소켓은 포트를 독점 (다른 소켓들은 하나의 포트 공유 가능)
  - 프로토콜이 다르면 포트를 공유 가능
- 포트는 호스트가 외부와 통신을 하기 위한 통로이며 0~65536의 범위
  - 기존에 사용하는 번호들을 피하기 위해 1023번 이상의 번호 중 사용하지 않는 포트를 골라서 사용
- 소켓은 입력 스트림과 출력 스트림을 상대편 소켓의 스트림들과 교차 연결하여 통신
- 소켓 프로그래밍을 위한 클래스
  - Socket : 프로세스 간의 통신을 담당, InputStream과 OutputStream을 가지고 있으며 이 스트림을 통해 통신
  - ServerSocket : 포트와 연결되어 외부의 연결 요청이 오면 Socket을 생성 후 통신이 이루어지게 하며 포트를 독점 (프로토콜이 다르면 공유 가능)
- ServerSocket
  - 생성자에 사용할 포트 번호를 지정
  - `accept()` 메서드 -> 대기 상태로 만든 후 클라이언트 프로그램의 연결 요청이 오면 새로운 소켓을 생성해서 클라이언트 프로그램의 소켓과 연결
  - setSoTimeout(int timeout)을 사용해서 서버 소켓의 대기시간 지정 가능 (천분의 일초 단위, 0일 시 제한 시간 없이 대기, 대기 시간 경과 후 SocketTimeoutException 발생)
- 서버와의 작업이 끝나면 소켓과 스트림을 닫아야 한다.
- 서버와 클라이언트의 연결 과정
  1. 서버 프로그램을 실행
  2. 서버 소켓을 생성
  3. 서버 소켓을 대기 상태로 만듦
  4. 클라이언트 프로그램에서 소켓을 생성하여 서버 소켓에 연결을 요청
  5. 서버 소켓은 클라이언트 프로그램의 연결 요청을 받아 새로운 소켓 생성 뒤 클라이언트 프로그램의 연결 요청이 오면 새로운 소켓을 생성 후 클라이언트 프로그램의 소켓과 연결
- Socket
  - getPort() : 상대편 소켓을 알아낼 수 있음
  - getLocalPort() : 소켓 자신이 사용하는 포트를 알아낼 수 있음
- 서버 소켓이 아닌 소켓은 서버 소켓이 사용하고 있는 포트를 사용할 수 있음
- 여러 개의 쓰레드를 생성해서 클라이언트의 요청을 동시에 처리할 수 있다.
  - 클라이언트의 수가 많을 때는 요청을 병렬로 처리하는 것이 좋음
- 소켓으로 데이터를 송신하는 작업과 수신하는 작업을 별도의 쓰레드로 처리하도록 할 수 있다.

### 2.3 UDP 소켓 프로그래밍

- UDP 소켓 프로그래밍에서는 DatagramSocket과 DatagramPacket을 사용
  - 연결 지향적인 프로토콜이 아니므로 ServerSocket이 필요 X
  - DatagramSocket을 소켓으로 사용하며 데이터를 DatagramPacket에 담아서 전송
  - DatagramPacket은 헤더와 데이터로 구성 (헤더엔 수신할 호스트의 정보가 저장)
- 클라이언트가 DatagramPacket을 생성해서 DatagramSocket으로 서버에 전송하면, 서버는 전송받은 DatagramPacket의 getAddress(), getPort()를 호출해서 클라이언트의 정보를 얻어서 서버 시간을 DatagramPacket에 담아서 전송
